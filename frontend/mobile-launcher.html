<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Game Launcher with Mobile Controls</title>
    
    <script src="game_config.js"></script> 
    
    <style>
        body { margin: 0; overflow: hidden; background-color: #333; }
        #game-wrapper {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        #game-iframe {
            border: none;
            width: 100%;
            height: 100%;
            display: block;
        }
        /* The dynamic controls will be appended to this overlay */
        #mobile-controls-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            /* Allow touch events to fall through by default */
            pointer-events: none; 
        }
        /* Base styles for the generated buttons */
        .control-button {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            touch-action: manipulation;
            user-select: none;
            /* Re-enable pointer events for the buttons */
            pointer-events: auto; 
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            transition: background 0.1s;
        }
        .control-button:active, .active-control {
            background: rgba(0, 150, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 150, 255, 0.8);
        }
        .dpad-container {
            position: absolute;
            pointer-events: auto;
        }
        .dpad-segment {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            pointer-events: auto;
        }
    </style>
</head>
<body>

    <div id="game-wrapper">
        <iframe id="game-iframe" src="" allowfullscreen></iframe>
        
        <div id="mobile-controls-overlay">
            </div>
    </div>

    <script>
        // --- CONTROL LOGIC SCRIPT ---

        // Check for configuration availability
        if (typeof GAME_LAUNCH_CONFIG === 'undefined') {
            alert('Error: GAME_LAUNCH_CONFIG is missing. Check game_config.js.');
        }

        const overlay = document.getElementById('mobile-controls-overlay');
        const iframe = document.getElementById('game-iframe');
        
        // 1. Function to simulate a key event
        function triggerKeyEvent(type, mapping) {
            // Note: Events must be dispatched on the window of the iframe's content
            const targetWindow = iframe.contentWindow || window; 
            
            const event = new targetWindow.KeyboardEvent(type, {
                key: mapping.key,
                keyCode: mapping.keyCode,
                which: mapping.keyCode,
                bubbles: true,
                cancelable: true
            });
            targetWindow.dispatchEvent(event);
        }
        
        // 2. General event handler to attach to buttons/dpad segments
        function attachEvents(element, mapping) {
            element.addEventListener('touchstart', (e) => {
                e.preventDefault(); 
                element.classList.add('active-control');
                triggerKeyEvent('keydown', mapping);
            });
            element.addEventListener('touchend', (e) => {
                e.preventDefault();
                element.classList.remove('active-control');
                triggerKeyEvent('keyup', mapping);
            });
            // Also include mouse events for compatibility/desktop testing
            element.addEventListener('mousedown', (e) => {
                e.preventDefault();
                element.classList.add('active-control');
                triggerKeyEvent('keydown', mapping);
            });
            element.addEventListener('mouseup', (e) => {
                e.preventDefault();
                element.classList.remove('active-control');
                triggerKeyEvent('keyup', mapping);
            });
        }

        // 3. Dynamic Control Generation
        function generateControls() {
            const vmin = Math.min(window.innerWidth, window.innerHeight);

            GAME_LAUNCH_CONFIG.controls.forEach(control => {
                if (control.type === 'button') {
                    // --- Generate a standard button ---
                    const button = document.createElement('div');
                    button.id = control.id;
                    button.className = 'control-button';
                    button.textContent = control.label || '';
                    
                    // Apply dynamic positioning and sizing based on config
                    Object.keys(control.position).forEach(key => {
                        button.style[key] = `${control.position[key]}%`;
                    });
                    const size = `${control.size}vmin`;
                    button.style.width = size;
                    button.style.height = size;
                    
                    attachEvents(button, { key: control.key, keyCode: control.keyCode });
                    overlay.appendChild(button);

                } else if (control.type === 'dpad') {
                    // --- Generate a D-Pad ---
                    const container = document.createElement('div');
                    container.id = control.id;
                    container.className = 'dpad-container';
                    
                    // D-Pad container size (a bit larger than the button segments)
                    const containerSize = control.size * 1.5; 
                    const segmentSize = control.size / 2; // Each segment is half the overall size

                    Object.keys(control.position).forEach(key => {
                        container.style[key] = `${control.position[key]}%`;
                    });
                    container.style.width = `${containerSize}vmin`;
                    container.style.height = `${containerSize}vmin`;
                    
                    // Create and position the segments
                    control.buttons.forEach(mapping => {
                        const segment = document.createElement('div');
                        segment.id = `${control.id}-${mapping.direction}`;
                        segment.className = 'control-button dpad-segment';
                        segment.textContent = mapping.direction.charAt(0).toUpperCase();

                        const segPx = `${segmentSize}vmin`;
                        segment.style.width = segPx;
                        segment.style.height = segPx;

                        // Position segments within the container
                        const halfContainer = containerSize / 2;
                        const halfSeg = segmentSize / 2;

                        if (mapping.direction === 'up') { segment.style.top = '0'; segment.style.left = `${halfContainer - halfSeg}vmin`; }
                        else if (mapping.direction === 'down') { segment.style.bottom = '0'; segment.style.left = `${halfContainer - halfSeg}vmin`; }
                        else if (mapping.direction === 'left') { segment.style.left = '0'; segment.style.top = `${halfContainer - halfSeg}vmin`; }
                        else if (mapping.direction === 'right') { segment.style.right = '0'; segment.style.top = `${halfContainer - halfSeg}vmin`; }
                        
                        attachEvents(segment, mapping);
                        container.appendChild(segment);
                    });

                    overlay.appendChild(container);
                }
            });
        }
        
        // 4. Initialization
        document.addEventListener('DOMContentLoaded', () => {
            // Set the iframe source to launch the game
            iframe.src = GAME_LAUNCH_CONFIG.targetGamePath;
            
            // Wait for the iframe to load before generating controls, 
            // though attaching the event listeners doesn't strictly require this
            iframe.onload = generateControls; 
        });

    </script>

</body>
</html>
