<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mobile Controls</title>

    <script src="mobile_controls_config.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #111; }
        #wrapper {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        #game-iframe {
            border: none;
            width: 100%;
            height: 100%;
            display: block;
            background: #000;
        }
        #overlay {
            position: absolute;
            inset: 0;
            z-index: 1000;
            pointer-events: none;
        }
        .control {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            user-select: none;
            touch-action: manipulation;
            pointer-events: auto;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255,255,255,0.15);
        }
        .control.active {
            background: rgba(0, 150, 255, 0.85);
            box-shadow: 0 0 15px rgba(0, 150, 255, 0.85);
        }
        .dpad {
            position: absolute;
            pointer-events: auto;
        }
        .dpad-segment {
            position: absolute;
            border-radius: 9999px;
            font-weight: 700;
        }
        #error {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-family: monospace;
            padding: 24px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="wrapper">
        <iframe id="game-iframe" src="about:blank" allowfullscreen></iframe>
        <div id="overlay"></div>
        <div id="error"></div>
    </div>

    <script>
        const iframe = document.getElementById('game-iframe');
        const overlay = document.getElementById('overlay');
        const errorEl = document.getElementById('error');

        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        function showError(message) {
            errorEl.style.display = 'flex';
            errorEl.textContent = message;
        }

        function getDispatchTargets() {
            try {
                const win = iframe.contentWindow;
                const doc = win && win.document;
                return [win, doc].filter(Boolean);
            } catch {
                return [];
            }
        }

        function dispatchKeyboardEvent(type, keyMapping) {
            const targets = getDispatchTargets();
            if (targets.length === 0) return;

            for (const t of targets) {
                try {
                    const evt = new KeyboardEvent(type, {
                        key: keyMapping.key,
                        keyCode: keyMapping.keyCode,
                        which: keyMapping.keyCode,
                        bubbles: true,
                        cancelable: true,
                    });
                    t.dispatchEvent(evt);
                } catch {
                }
            }
        }

        function pressKeys(keys) {
            for (const k of keys) dispatchKeyboardEvent('keydown', k);
        }

        function releaseKeys(keys) {
            for (const k of keys) dispatchKeyboardEvent('keyup', k);
        }

        function attachPressHandlers(el, keys) {
            const normalizedKeys = Array.isArray(keys) ? keys : [];
            const down = (e) => {
                e.preventDefault();
                el.classList.add('active');
                pressKeys(normalizedKeys);
            };
            const up = (e) => {
                e.preventDefault();
                el.classList.remove('active');
                releaseKeys(normalizedKeys);
            };

            el.addEventListener('touchstart', down, { passive: false });
            el.addEventListener('touchend', up, { passive: false });
            el.addEventListener('touchcancel', up, { passive: false });

            el.addEventListener('mousedown', down);
            el.addEventListener('mouseup', up);
            el.addEventListener('mouseleave', up);
        }

        function applyPosition(el, position) {
            Object.keys(position || {}).forEach((side) => {
                el.style[side] = `${position[side]}%`;
            });
        }

        function clearControls() {
            while (overlay.firstChild) overlay.removeChild(overlay.firstChild);
        }

        function directionLabel(dir) {
            if (dir === 'up') return '↑';
            if (dir === 'down') return '↓';
            if (dir === 'left') return '←';
            if (dir === 'right') return '→';
            return dir;
        }

        function renderButton(control) {
            const btn = document.createElement('div');
            btn.className = 'control';
            btn.id = control.id;
            btn.textContent = control.label || control.title || '';
            if (control.title) btn.setAttribute('aria-label', control.title);

            applyPosition(btn, control.position);

            const size = `${control.size}vmin`;
            btn.style.width = size;
            btn.style.height = size;

            attachPressHandlers(btn, control.keys);
            overlay.appendChild(btn);
        }

        function renderDpad(control) {
            const container = document.createElement('div');
            container.className = 'dpad';
            container.id = control.id;
            if (control.title) container.setAttribute('aria-label', control.title);

            applyPosition(container, control.position);

            const size = Number(control.size) || 18;
            const containerSize = size * 1.6;
            const segmentSize = size / 2;

            container.style.width = `${containerSize}vmin`;
            container.style.height = `${containerSize}vmin`;

            const dirs = control.directions || {};
            const dirKeys = Object.keys(dirs);

            dirKeys.forEach((dir) => {
                const seg = document.createElement('div');
                seg.className = 'control dpad-segment';
                seg.id = `${control.id}-${dir}`;
                seg.textContent = directionLabel(dir);

                seg.style.width = `${segmentSize}vmin`;
                seg.style.height = `${segmentSize}vmin`;

                const halfContainer = containerSize / 2;
                const halfSeg = segmentSize / 2;

                if (dir === 'up') {
                    seg.style.top = '0';
                    seg.style.left = `${halfContainer - halfSeg}vmin`;
                } else if (dir === 'down') {
                    seg.style.bottom = '0';
                    seg.style.left = `${halfContainer - halfSeg}vmin`;
                } else if (dir === 'left') {
                    seg.style.left = '0';
                    seg.style.top = `${halfContainer - halfSeg}vmin`;
                } else if (dir === 'right') {
                    seg.style.right = '0';
                    seg.style.top = `${halfContainer - halfSeg}vmin`;
                } else {
                    seg.style.left = `${halfContainer - halfSeg}vmin`;
                    seg.style.top = `${halfContainer - halfSeg}vmin`;
                }

                attachPressHandlers(seg, dirs[dir]);
                container.appendChild(seg);
            });

            overlay.appendChild(container);
        }

        function generateControlsForTarget(targetPath) {
            if (typeof getMobileControlsForTarget !== 'function') {
                showError('Missing getMobileControlsForTarget(). Check mobile_controls_config.js.');
                return;
            }

            const config = getMobileControlsForTarget(targetPath);
            const controls = (config && Array.isArray(config.controls)) ? config.controls : [];

            clearControls();

            controls.forEach((control) => {
                if (!control || !control.type) return;
                if (control.type === 'button') return renderButton(control);
                if (control.type === 'dpad') return renderDpad(control);
            });
        }

        function boot() {
            const target = getQueryParam('target');
            if (!target) {
                showError('Missing ?target=... in URL. Example: mobile.html?target=frontend/weather-duck-rpg.html');
                return;
            }

            iframe.src = target;

            iframe.addEventListener('load', () => {
                generateControlsForTarget(target);
                try {
                    iframe.contentWindow.focus();
                } catch {
                }
            });

            let resizeTimer = null;
            window.addEventListener('resize', () => {
                window.clearTimeout(resizeTimer);
                resizeTimer = window.setTimeout(() => generateControlsForTarget(target), 100);
            });
        }

        document.addEventListener('DOMContentLoaded', boot);
    </script>
</body>
</html>
